# é£ä¹¦ç­¾ååŠ©æ‰‹ - å¼€å‘æ–‡æ¡£

> æœ¬æ–‡æ¡£ä¸ºå¼€å‘äººå‘˜æä¾›é¡¹ç›®çš„å®Œæ•´æŠ€æœ¯è¯´æ˜ï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€å¼€å‘ç¯å¢ƒæ­å»ºã€API æ¥å£è¯´æ˜å’Œéƒ¨ç½²æŒ‡å—ã€‚

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
feishu1/
â”œâ”€â”€ backend/                   # Python åç«¯æœåŠ¡
â”‚   â”œâ”€â”€ main.py               # FastAPI ä¸»å…¥å£
â”‚   â”œâ”€â”€ database.py           # æ•°æ®åº“æ¨¡å‹å®šä¹‰ (SQLAlchemy ORM)
â”‚   â”œâ”€â”€ admin_router.py       # ç®¡ç†åå° API è·¯ç”±
â”‚   â”œâ”€â”€ form_router.py        # å¤–éƒ¨ç­¾åè¡¨å• API è·¯ç”±
â”‚   â”œâ”€â”€ quota_router.py       # é…é¢ç®¡ç† API è·¯ç”±
â”‚   â”œâ”€â”€ quota_service.py      # é…é¢ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”‚   â”œâ”€â”€ session_store.py      # Redis Session å­˜å‚¨
â”‚   â”œâ”€â”€ logger.py             # æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ errors.py             # é”™è¯¯ç å®šä¹‰
â”‚   â”œâ”€â”€ payment/              # æ”¯ä»˜ç›¸å…³æ¨¡å—
â”‚   â”œâ”€â”€ requirements.txt      # Python ä¾èµ–
â”‚   â””â”€â”€ .env.example          # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚
â”œâ”€â”€ frontend/                  # å‰ç«¯åº”ç”¨
â”‚   â”œâ”€â”€ vue-template/         # ç”¨æˆ·ç«¯ Vue åº”ç”¨ï¼ˆé£ä¹¦å°ç¨‹åº/å¤šç»´è¡¨æ ¼æ’ä»¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ components/   # Vue ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ composables/  # ç»„åˆå¼å‡½æ•°
â”‚   â”‚   â”‚   â”œâ”€â”€ services/     # API æœåŠ¡å°è£…
â”‚   â”‚   â”‚   â”œâ”€â”€ locales/      # å›½é™…åŒ–é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ router.js     # è·¯ç”±é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ main.js       # å…¥å£æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ vite.config.js
â”‚   â”‚
â”‚   â””â”€â”€ admin/                # ç®¡ç†åå°
â”‚       â””â”€â”€ src/              # ç®¡ç†ç«¯æºç 
â”‚
â”œâ”€â”€ nginx/                     # Nginx é…ç½®
â”œâ”€â”€ deploy-backend.sh          # åç«¯éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ quick-deploy.sh            # å¿«é€Ÿéƒ¨ç½²è„šæœ¬
â””â”€â”€ .gitignore
```

---

## ğŸ›  æŠ€æœ¯æ ˆ

### åç«¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Python** | 3.10+ | è¿è¡Œæ—¶ç¯å¢ƒ |
| **FastAPI** | â‰¥0.110.0 | Web æ¡†æ¶ |
| **Uvicorn** | â‰¥0.23.0 | ASGI æœåŠ¡å™¨ |
| **SQLAlchemy** | â‰¥2.0.0 | ORM æ•°æ®åº“æ“ä½œ |
| **PyMySQL** | â‰¥1.1.0 | MySQL é©±åŠ¨ |
| **Redis** | â‰¥5.0.0 | Session å­˜å‚¨ |

### å‰ç«¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Vue.js** | 3.x | UI æ¡†æ¶ |
| **Vite** | 3.x | æ„å»ºå·¥å…· |
| **Element Plus** | 2.x | UI ç»„ä»¶åº“ |
| **Vue Router** | 4.x | è·¯ç”±ç®¡ç† |
| **Vue I18n** | 9.x | å›½é™…åŒ– |
| **axios** | 1.x | HTTP å®¢æˆ·ç«¯ |
| **@lark-base-open/js-sdk** | 0.5.x | é£ä¹¦å¤šç»´è¡¨æ ¼ SDK |

### åŸºç¡€è®¾æ–½

| æœåŠ¡ | ç”¨é€” |
|------|------|
| **MySQL** | ä¸»æ•°æ®åº“ |
| **Redis** | Session ç¼“å­˜ |
| **Nginx** | åå‘ä»£ç† / é™æ€èµ„æºæœåŠ¡ |

---

## ğŸ—„ æ•°æ®åº“è®¾è®¡

### æ•°æ®è¡¨æ¦‚è§ˆ

| è¡¨å | æè¿° |
|------|------|
| `users` | ç”¨æˆ·ä¿¡æ¯è¡¨ |
| `invite_codes` | é‚€è¯·ç è¡¨ |
| `orders` | è®¢å•è¡¨ |
| `pricing_plans` | å®šä»·å¥—é¤è¡¨ |
| `signature_logs` | ç­¾åè®°å½•è¡¨ |
| `sign_forms` | å¤–éƒ¨ç­¾åè¡¨å•é…ç½®è¡¨ |

### æ ¸å¿ƒè¡¨ç»“æ„

#### usersï¼ˆç”¨æˆ·è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | INT | ä¸»é”® |
| `open_id` | VARCHAR(128) | é£ä¹¦ç”¨æˆ· Open ID |
| `tenant_key` | VARCHAR(128) | ç§Ÿæˆ·æ ‡è¯† |
| `user_key` | VARCHAR(256) | å”¯ä¸€ç”¨æˆ·æ ‡è¯† (open_id::tenant_key) |
| `remaining_quota` | INT | å‰©ä½™ç­¾åé…é¢ |
| `total_used` | INT | æ€»ä½¿ç”¨æ¬¡æ•° |
| `invite_code_used` | VARCHAR(64) | ä½¿ç”¨çš„é‚€è¯·ç  |
| `total_paid` | INT | ç´¯è®¡ä»˜è´¹é‡‘é¢ï¼ˆåˆ†ï¼‰ |

#### sign_formsï¼ˆç­¾åè¡¨å•é…ç½®è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `form_id` | VARCHAR(32) | è¡¨å•å”¯ä¸€ ID |
| `name` | VARCHAR(100) | è¡¨å•åç§° |
| `app_token` | VARCHAR(64) | å…³è”çš„å¤šç»´è¡¨æ ¼ Token |
| `table_id` | VARCHAR(64) | è¡¨æ ¼ ID |
| `signature_field_id` | VARCHAR(64) | ç­¾åé™„ä»¶å­—æ®µ ID |
| `extra_fields` | TEXT | é¢å¤–å­—æ®µé…ç½® (JSON) |
| `is_active` | BOOLEAN | æ˜¯å¦å¯ç”¨ |

---

## ğŸš€ å¼€å‘ç¯å¢ƒæ­å»º

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£… Python 3.10+
# å®‰è£… Node.js 18+
# å®‰è£… MySQL 8.0+
# å®‰è£… Redis 6.0+
```

### 2. åç«¯å¯åŠ¨

```bash
cd backend

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv .venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ (Windows)
.venv\Scripts\activate
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ (Linux/macOS)
source .venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¤åˆ¶å¹¶é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥é£ä¹¦åº”ç”¨å‡­æ®å’Œæ•°æ®åº“é…ç½®

# åˆå§‹åŒ–æ•°æ®åº“
python database.py

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
python main.py
# æˆ–ä½¿ç”¨ uvicorn
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 3. å‰ç«¯å¯åŠ¨

```bash
cd frontend/vue-template

# å®‰è£…ä¾èµ–
npm install

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.production .env.local
# ç¼–è¾‘ .env.local è®¾ç½®åç«¯ API åœ°å€

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

---

## ğŸ” ç¯å¢ƒå˜é‡é…ç½®

### åç«¯ `.env` é…ç½®é¡¹

```bash
# é£ä¹¦åº”ç”¨é…ç½®ï¼ˆå¿…å¡«ï¼‰
APP_ID=your_feishu_app_id
APP_SECRET=your_feishu_app_secret
PARENT_TYPE=explorer
PARENT_NODE=root

# MySQL æ•°æ®åº“é…ç½®ï¼ˆå¿…å¡«ï¼‰
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_mysql_password
MYSQL_DATABASE=feishu

# Redis é…ç½®ï¼ˆæ¨èï¼‰
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
SESSION_EXPIRE_SECONDS=86400

# åç«¯ URLï¼ˆç”¨äº OAuth å›è°ƒï¼‰
BACKEND_BASE=http://localhost:8000

# CORS å…è®¸çš„æ¥æº
CORS_ORIGINS=http://localhost:5173
```

---

## ğŸ“¡ API æ¥å£æ¦‚è§ˆ

åç«¯æä¾› OpenAPI æ–‡æ¡£ï¼Œå¯åŠ¨åè®¿é—®ï¼š
- **Swagger UI**: `http://localhost:8000/docs`
- **ReDoc**: `http://localhost:8000/redoc`

### æ ¸å¿ƒæ¥å£

| æ¨¡å— | ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|------|
| **è®¤è¯** | `/auth/start` | GET | å¯åŠ¨é£ä¹¦ OAuth æˆæƒ |
| **è®¤è¯** | `/auth/callback` | GET | OAuth å›è°ƒå¤„ç† |
| **è®¤è¯** | `/auth/status` | GET | æŸ¥è¯¢æˆæƒçŠ¶æ€ |
| **ç­¾å** | `/upload-signature` | POST | ä¸Šä¼ ç­¾åæ–‡ä»¶ |
| **é…é¢** | `/api/quota/*` | - | é…é¢æŸ¥è¯¢ä¸ç®¡ç† |
| **è¡¨å•** | `/api/forms/*` | - | å¤–éƒ¨ç­¾åè¡¨å•ç®¡ç† |
| **ç®¡ç†** | `/api/admin/*` | - | åå°ç®¡ç†æ¥å£ |
| **å¥åº·** | `/healthz` | GET | å¥åº·æ£€æŸ¥ |

### é”™è¯¯ç è¯´æ˜

| é”™è¯¯ç  | è¯´æ˜ |
|--------|------|
| 0 | æˆåŠŸ |
| 1100 | é…é¢ä¸è¶³ |
| 1300 | è¡¨å•ä¸å­˜åœ¨ |
| 1500 | é£ä¹¦ API é”™è¯¯ |

---

## ğŸ“¦ éƒ¨ç½²æŒ‡å—

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### 1. åç«¯éƒ¨ç½²

```bash
# ä½¿ç”¨éƒ¨ç½²è„šæœ¬
chmod +x deploy-backend.sh
./deploy-backend.sh
```

æˆ–æ‰‹åŠ¨éƒ¨ç½²ï¼š

```bash
cd backend

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# ä½¿ç”¨ systemd ç®¡ç†æœåŠ¡
sudo cp feishu-backend.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable feishu-backend
sudo systemctl start feishu-backend
```

#### 2. å‰ç«¯æ„å»º

```bash
cd frontend/vue-template

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# å°† dist ç›®å½•éƒ¨ç½²åˆ° Nginx
```

#### 3. Nginx é…ç½®

å‚è€ƒ `nginx/` ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®åå‘ä»£ç†å’Œé™æ€èµ„æºæœåŠ¡ã€‚

---

## ğŸ”§ å¼€å‘è§„èŒƒ

### ä»£ç é£æ ¼

- **Python**: éµå¾ª PEP 8 è§„èŒƒ
- **JavaScript/Vue**: ä½¿ç”¨ ESLint + Prettier
- **æäº¤ä¿¡æ¯**: ä½¿ç”¨ä¸­æ–‡æè¿°ï¼Œæ ¼å¼å¦‚ `feat: æ–°å¢xxxåŠŸèƒ½`

### åˆ†æ”¯ç®¡ç†

| åˆ†æ”¯ | ç”¨é€” |
|------|------|
| `main` | ç”Ÿäº§ç¯å¢ƒåˆ†æ”¯ |
| `develop` | å¼€å‘é›†æˆåˆ†æ”¯ |
| `feature/*` | åŠŸèƒ½å¼€å‘åˆ†æ”¯ |
| `hotfix/*` | ç´§æ€¥ä¿®å¤åˆ†æ”¯ |

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q: æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Ÿ

æ£€æŸ¥ MySQL æœåŠ¡æ˜¯å¦è¿è¡Œï¼Œå¹¶ç¡®è®¤ `.env` ä¸­çš„æ•°æ®åº“é…ç½®æ­£ç¡®ã€‚

### Q: Redis è¿æ¥å¤±è´¥ï¼Ÿ

é¡¹ç›®æ”¯æŒ Redis ä¸å¯ç”¨æ—¶è‡ªåŠ¨å›é€€åˆ°å†…å­˜å­˜å‚¨ï¼Œä½†ç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨ Redisã€‚

### Q: OAuth æˆæƒå¤±è´¥ï¼Ÿ

1. ç¡®è®¤é£ä¹¦åº”ç”¨çš„é‡å®šå‘ URL å·²æ­£ç¡®é…ç½®
2. æ£€æŸ¥ `BACKEND_BASE` ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®

### Q: è·¨åŸŸè¯·æ±‚è¢«æ‹’ç»ï¼Ÿ

æ›´æ–° `CORS_ORIGINS` ç¯å¢ƒå˜é‡ï¼Œæ·»åŠ å‰ç«¯åŸŸåã€‚

---

## ğŸ“š ç›¸å…³èµ„æº

- [é£ä¹¦å¼€æ”¾å¹³å°æ–‡æ¡£](https://open.feishu.cn/document/home/index)
- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Vue.js 3 æ–‡æ¡£](https://vuejs.org/)
- [Element Plus æ–‡æ¡£](https://element-plus.org/)
